<!doctype html>
<html lang="ko">
<head>
  <title>Lab Shop | Product</title>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/style.css" />
  <script>
    // dataLayerëŠ” GTMì´ ë¡œë“œë˜ê¸° ì „ì— ë¨¼ì € ì„ ì–¸í•˜ëŠ” ê²ƒì´ ê¶Œì¥ë©ë‹ˆë‹¤.
    window.dataLayer = window.dataLayer || [];
  </script>

  <!-- GTM HEAD SNIPPET: Google Tag Managerì—ì„œ ë³µì‚¬í•œ <script>...</script>ë¥¼ ì—¬ê¸° ë¶™ì—¬ë„£ìœ¼ì„¸ìš” -->
   
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-TTWSJGDJ');</script>
  <!-- End Google Tag Manager -->

</head>
<body>

  <!-- GTM BODY SNIPPET: Google Tag Managerì—ì„œ ë³µì‚¬í•œ <noscript>...</noscript>ë¥¼ ì—¬ê¸° ë¶™ì—¬ë„£ìœ¼ì„¸ìš” -->

<header class="container">
  <a class="brand" href="index.html" aria-label="Home">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>GTM + GA4 ì „ììƒê±°ë˜ ì‹¤ìŠµ ë¯¸ë‹ˆìƒµ</h1>
      <div class="small">ì •ì  í˜ì´ì§€( GitHub Pages ) + dataLayer ê¸°ë°˜ ì´ë²¤íŠ¸</div>
    </div>
  </a>

  <nav class="nav">
    <div class="pill">
      <label style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" data-member-toggle />
        <span data-member-label>íšŒì›ê°€ OFF</span>
      </label>
    </div>

    <a class="pill" href="cart.html">
      ğŸ›’ ì¥ë°”êµ¬ë‹ˆ
      <span class="badge" data-cart-count>0</span>
    </a>
  </nav>
</header>

<main class="container">
  <section class="panel" id="productPanel">
    <h2 id="pName" style="margin:0 0 8px;">ìƒí’ˆ ìƒì„¸</h2>
    <div class="meta" id="pMeta"></div>
    <div class="price" style="margin-top:10px;">
      <strong id="pPrice">-</strong>
      <span id="pDiscount">-</span>
    </div>

    <div class="row" style="margin-top:12px;">
      <div style="min-width:140px;">
        <label>ìˆ˜ëŸ‰</label>
        <input type="number" id="qty" min="1" value="1" />
      </div>
      <div style="flex:1; min-width:200px;">
        <label>ë™ì‘</label>
        <div class="row" style="margin-top:6px;">
          <button class="btn" id="btnAdd">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
          <a class="btn secondary" href="cart.html">ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™</a>
        </div>
      </div>
    </div>

    <div class="small" style="margin-top:10px;">
      ì´ í˜ì´ì§€ ë¡œë“œ ì‹œ <code class="inline">view_item</code>ê°€ ì „ì†¡ë©ë‹ˆë‹¤.
      <br/>ë˜í•œ <strong>ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</strong>ëŠ” (ì‹¤ìŠµìš©) í˜ì´ì§€ì—ì„œ <code class="inline">dataLayer.push</code>ë¥¼ í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, GTMì˜ <code class="inline">ë§ì¶¤ HTML</code>ë¡œ <code class="inline">add_to_cart</code>ë¥¼ êµ¬í˜„í•´ë³´ì„¸ìš”.
      ë©”ì¸ì—ì„œ ë„˜ì–´ì˜¨ ê²½ìš°(ì¿¼ë¦¬ìŠ¤íŠ¸ë§ í¬í•¨) <code class="inline">select_item</code>ë„ í•¨ê»˜ ì „ì†¡ë©ë‹ˆë‹¤.
    </div>
  </section>

  <section class="panel" style="margin-top:12px;">
    <h3 style="margin:0 0 8px;">í•™ìŠµ í¬ì¸íŠ¸</h3>
    <ul class="small">
      <li>ë©”ì¸ í˜ì´ì§€ì˜ <code class="inline">view_item_list</code> â†’ ìƒì„¸ í˜ì´ì§€ì˜ <code class="inline">select_item</code>/<code class="inline">view_item</code> íë¦„ì„ GA4 ê²½ë¡œ/í¼ë„ íƒìƒ‰ì—ì„œ í™•ì¸</li>
      <li>íšŒì›ê°€(í• ì¸) íŠ¸ë˜í‚¹: itemì˜ <code class="inline">price</code>, <code class="inline">discount</code>, <code class="inline">item_variant</code>, ê·¸ë¦¬ê³  ì»¤ìŠ¤í…€ <code class="inline">price_type</code> í™•ì¸</li>
    </ul>
  </section>
</main>

<footer class="container">
  <div>
    ì´ í˜ì´ì§€ëŠ” GA4/GTM ì‹¤ìŠµìš© ê°€ì§œ ìŠ¤í† ì–´ì…ë‹ˆë‹¤. ì‹¤ì œ ê²°ì œ/íšŒì›/ê°œì¸ì •ë³´ ìˆ˜ì§‘ì€ ì—†ìŠµë‹ˆë‹¤.
  </div>
  <div class="small">
    íŒ) ë¸Œë¼ìš°ì € ê´‘ê³  ì°¨ë‹¨ í™•ì¥í”„ë¡œê·¸ë¨ì´ GA/GTM ìš”ì²­ì„ ë§‰ì„ ìˆ˜ ìˆì–´ìš”. í…ŒìŠ¤íŠ¸ ì¤‘ì—” ì ì‹œ êº¼ë³´ëŠ” ê²Œ ì¢‹ìŠµë‹ˆë‹¤.
  </div>
</footer>

<script src="assets/shop.js"></script>
<script>
  function getParam(name) {
    return new URLSearchParams(location.search).get(name);
  }

  function renderProduct() {
    setMemberToggleUI();
    updateCartBadge();

    const sku = getParam("sku") || "SKU_001";
    const list_id = getParam("list_id");
    const list_name = getParam("list_name");
    const index = Number(getParam("index"));

    const product = getProduct(sku);
    if (!product) {
      document.getElementById("productPanel").innerHTML = "<h2>ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h2><a class='btn' href='index.html'>í™ˆìœ¼ë¡œ</a>";
      return;
    }

    const { item, price_type } = buildItem(product, 1, {
      item_list_id: list_id || undefined,
      item_list_name: list_name || undefined,
      index: Number.isFinite(index) ? index : undefined
    });

    document.getElementById("pName").textContent = product.item_name;
    document.getElementById("pMeta").innerHTML = `
      <span>ì¹´í…Œê³ ë¦¬: ${product.item_category}</span>
      <span>SKU: <code class="inline">${product.item_id}</code></span>
      <span>price_type: <code class="inline">${price_type}</code></span>
      <span>item_variant: <code class="inline">${item.item_variant}</code></span>
    `;

    document.getElementById("pPrice").textContent = `${formatKRW(item.price)}ì›`;
    document.getElementById("pDiscount").textContent = item.discount ? `í• ì¸ -${formatKRW(item.discount)}ì›` : "í• ì¸ ì—†ìŒ";

    // ë©”ì¸ì—ì„œ ë„˜ì–´ì˜¨ íë¦„ì„ "ì„ íƒ" ì´ë²¤íŠ¸ë¡œ ê¸°ë¡ (select_item)
    if (list_id && list_name) {
      pushEcomEvent("select_item", {
        item_list_id: list_id,
        item_list_name: list_name,
        price_type: price_type,
        ecommerce: { items: [item] }
      });
    }

    // ìƒì„¸ ë…¸ì¶œ (view_item)
    pushEcomEvent("view_item", {
      price_type: price_type,
      ecommerce: { items: [item] }
    });

    
    // ---------------- ë§ì¶¤ HTML ì‹¤ìŠµìš© ë°ì´í„°(ë²„íŠ¼ dataset) ----------------
    // GTM "ë§ì¶¤ HTML" íƒœê·¸ì—ì„œ ì•„ë˜ dataset/DOM ê°’ì„ ì½ì–´ add_to_cart payloadë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    const btnAdd = document.getElementById("btnAdd");
    btnAdd.dataset.sku = product.item_id;
    btnAdd.dataset.name = product.item_name;
    btnAdd.dataset.category = product.item_category;
    btnAdd.dataset.brand = product.item_brand;
    btnAdd.dataset.regularPrice = String(product.regular_price);
    btnAdd.dataset.memberPrice = String(product.member_price);
    // í˜„ì¬ í‘œì‹œ ê°€ê²©(íšŒì›ê°€ í† ê¸€ì— ë”°ë¼ ë°”ë€œ)
    btnAdd.dataset.price = String(item.price);
    btnAdd.dataset.discount = String(item.discount || 0);
    btnAdd.dataset.variant = String(item.item_variant || "");
    btnAdd.dataset.priceType = String(price_type);
    btnAdd.dataset.currency = String(CURRENCY);

document.getElementById("btnAdd").onclick = () => {
      const qty = Math.max(1, Number(document.getElementById("qty").value || 1));
      const { item: cartItem, price_type: pt } = buildItem(product, qty);
      addToCart(cartItem);

      // (ì‹¤ìŠµìš©) ì´ í˜ì´ì§€ëŠ” add_to_cartë¥¼ dataLayerë¡œ ì§ì ‘ pushí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      // GTMì—ì„œ "ë§ì¶¤ HTML" íƒœê·¸ë¡œ add_to_cart ì´ë²¤íŠ¸ë¥¼ ì§ì ‘ ë§Œë“¤ì–´ pushí•´ë³´ì„¸ìš”.

      alert("ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤. (add_to_cartëŠ” GTM ë§ì¶¤ HTMLì—ì„œ ì „ì†¡ ì‹¤ìŠµ)");
    };
  }

  bindMemberToggle(renderProduct);
  renderProduct();
</script>
</body>
</html>
