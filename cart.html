<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GA4 + GTM Lab | Cart</title>
  <link rel="stylesheet" href="assets/style.css" />
  <script>
    window.dataLayer = window.dataLayer || [];
  </script>
  <!-- GTM_HEAD_SLOT -->
</head>
<body>
  <!-- GTM_BODY_SLOT -->

  <header class="site-header">
    <div class="container topbar">
      <a class="brand" href="index.html">GA4 + GTM Static Lab Shop</a>
      <div class="top-controls">
        <span class="mode-chip">Tracking: <strong data-current-mode>standard</strong></span>
        <a class="cart-link" href="cart.html">Cart <span class="badge" data-cart-count>0</span></a>
      </div>
    </div>
    <nav class="container page-nav">
      <a href="index.html" data-nav-page="index">Home</a>
      <a href="product-sku-001.html" data-nav-page="product">Product</a>
      <a href="cart.html" data-nav-page="cart">Cart</a>
      <a href="checkout.html" data-nav-page="checkout">Checkout</a>
      <a href="thankyou.html" data-nav-page="thankyou">Thankyou</a>
      <a href="form.html" data-nav-page="form">Lead Form</a>
      <a href="buttons.html" data-nav-page="buttons">Buttons</a>
      <a href="builder.html" data-nav-page="builder">Platform Ref</a>
    </nav>
  </header>

  <main class="container">
    <section class="panel">
      <h1 class="page-title">장바구니</h1>
      <p class="small">페이지 로드시 <code>view_cart</code>를 1회 전송합니다.</p>
      <div id="cartContent"></div>
    </section>
  </main>

  <script src="assets/data.js"></script>
  <script src="assets/app.js"></script>
  <script>
    LAB.initCommon("cart");

    var cartContent = document.getElementById("cartContent");
    var hasPushedViewCart = false;

    function renderCart() {
      var cart = LAB.getCart();

      if (!hasPushedViewCart) {
        hasPushedViewCart = true;
        LAB.pushEcomEvent("view_cart", {
          currency: LAB.currency,
          value: LAB.calcValue(cart),
          ecommerce: { items: cart }
        });
      }

      if (!cart.length) {
        cartContent.innerHTML =
          '<p class="small">장바구니가 비었습니다.</p>' +
          '<a class="btn secondary" href="index.html">상품 보러가기</a>';
        return;
      }

      var rows = cart.map(function (item, index) {
        var subtotal = Number(item.price) * Number(item.quantity);
        return (
          "<tr>" +
          "<td>" + item.item_name + "<div class='small'>SKU: " + item.item_id + "</div></td>" +
          "<td>" + LAB.formatMoney(item.price) + " KRW</td>" +
          "<td><input type='number' min='1' value='" + item.quantity + "' data-qty-index='" + index + "' /></td>" +
          "<td>" + LAB.formatMoney(subtotal) + " KRW</td>" +
          "<td><button class='btn danger' type='button' data-remove-index='" + index + "'>삭제</button></td>" +
          "</tr>"
        );
      }).join("");

      cartContent.innerHTML =
        '<div class="table-wrap">' +
        "  <table>" +
        "    <thead><tr><th>상품</th><th>단가</th><th>수량</th><th>합계</th><th>액션</th></tr></thead>" +
        "    <tbody>" + rows + "</tbody>" +
        "  </table>" +
        "</div>" +
        '<p style="margin-top:10px;"><strong>총액: ' + LAB.formatMoney(LAB.calcValue(cart)) + ' KRW</strong></p>' +
        '<div class="btn-row">' +
        '  <a class="btn secondary" href="index.html">쇼핑 계속</a>' +
        '  <button class="btn accent" id="btnCheckout" type="button">주문하기 (begin_checkout)</button>' +
        '  <button class="btn danger" id="btnClearCart" type="button">장바구니 비우기</button>' +
        "</div>" +
        '<p id="cartStatus" class="small" style="margin-top:10px;"></p>';

      cartContent.querySelectorAll("[data-qty-index]").forEach(function (input) {
        input.addEventListener("change", function () {
          var idx = Number(input.getAttribute("data-qty-index"));
          var qty = Math.max(1, Number(input.value || 1));
          var nextCart = LAB.getCart();
          nextCart[idx].quantity = qty;
          LAB.setCart(nextCart);
          renderCart();
        });
      });

      cartContent.querySelectorAll("[data-remove-index]").forEach(function (button) {
        button.addEventListener("click", function () {
          var idx = Number(button.getAttribute("data-remove-index"));
          var nextCart = LAB.getCart();
          nextCart.splice(idx, 1);
          LAB.setCart(nextCart);
          renderCart();
        });
      });

      document.getElementById("btnClearCart").addEventListener("click", function () {
        LAB.clearCart();
        renderCart();
      });

      document.getElementById("btnCheckout").addEventListener("click", function () {
        var currentCart = LAB.getCart();
        if (!currentCart.length) return;
        var status = document.getElementById("cartStatus");
        status.textContent = "";
        try {
          LAB.pushEcomEvent("begin_checkout", {
            currency: LAB.currency,
            value: LAB.calcValue(currentCart),
            ecommerce: { items: currentCart }
          });
          window.location.href = "checkout.html";
        } catch (err) {
          status.textContent = "begin_checkout push 실패로 이동이 차단되었습니다.";
        }
      });
    }

    renderCart();
  </script>
</body>
</html>



