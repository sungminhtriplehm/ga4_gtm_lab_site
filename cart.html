<!doctype html>
<html lang="ko">
<head>
  <title>Lab Shop | Cart</title>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/style.css" />
  <script>
    // dataLayerëŠ” GTMì´ ë¡œë“œë˜ê¸° ì „ì— ë¨¼ì € ì„ ì–¸í•˜ëŠ” ê²ƒì´ ê¶Œì¥ë©ë‹ˆë‹¤.
    window.dataLayer = window.dataLayer || [];
  </script>

  <!-- GTM HEAD SNIPPET: Google Tag Managerì—ì„œ ë³µì‚¬í•œ <script>...</script>ë¥¼ ì—¬ê¸° ë¶™ì—¬ë„£ìœ¼ì„¸ìš” -->
   
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-TTWSJGDJ');</script>
  <!-- End Google Tag Manager -->

</head>
<body>

  <!-- GTM BODY SNIPPET: Google Tag Managerì—ì„œ ë³µì‚¬í•œ <noscript>...</noscript>ë¥¼ ì—¬ê¸° ë¶™ì—¬ë„£ìœ¼ì„¸ìš” -->

<header class="container">
  <a class="brand" href="index.html" aria-label="Home">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>GTM + GA4 ì „ììƒê±°ë˜ ì‹¤ìŠµ ë¯¸ë‹ˆìƒµ</h1>
      <div class="small">ì •ì  í˜ì´ì§€( GitHub Pages ) + dataLayer ê¸°ë°˜ ì´ë²¤íŠ¸</div>
    </div>
  </a>

  <nav class="nav">
    <div class="pill">
      <label style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" data-member-toggle />
        <span data-member-label>íšŒì›ê°€ OFF</span>
      </label>
    </div>

    <a class="pill" href="cart.html">
      ğŸ›’ ì¥ë°”êµ¬ë‹ˆ
      <span class="badge" data-cart-count>0</span>
    </a>
  </nav>
</header>

<main class="container">
  <section class="panel">
    <h2 style="margin:0 0 8px;">ì¥ë°”êµ¬ë‹ˆ</h2>
    <div class="small">í˜ì´ì§€ ë¡œë“œ ì‹œ <code class="inline">view_cart</code> ì´ë²¤íŠ¸ê°€ ì „ì†¡ë©ë‹ˆë‹¤.</div>

    <div id="empty" class="small" style="margin-top:10px; display:none;">
      ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. <a class="btn" href="index.html" style="margin-left:8px;">ìƒí’ˆ ë³´ëŸ¬ê°€ê¸°</a>
    </div>

    <div id="tableWrap" style="margin-top:10px; display:none;">
      <table class="table" aria-label="cart table">
        <thead>
          <tr>
            <th>ìƒí’ˆ</th>
            <th>ë‹¨ê°€</th>
            <th>ìˆ˜ëŸ‰</th>
            <th>ì†Œê³„</th>
            <th>ì‘ì—…</th>
          </tr>
        </thead>
        <tbody id="cartBody"></tbody>
      </table>

      <div class="kpi">
        <div class="box">
          <div class="label">ìƒí’ˆ ìˆ˜</div>
          <div class="value" id="kpiCount">0</div>
        </div>
        <div class="box">
          <div class="label">ì´ì•¡ (value)</div>
          <div class="value" id="kpiValue">0</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <a class="btn secondary" href="index.html">ê³„ì† ì‡¼í•‘</a>
        <button class="btn" id="btnCheckout">ì£¼ë¬¸í•˜ê¸°(Checkout)</button>
        <button class="btn danger" id="btnClear">ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°</button>
      </div>
    </div>
  </section>
</main>

<footer class="container">
  <div>
    ì´ í˜ì´ì§€ëŠ” GA4/GTM ì‹¤ìŠµìš© ê°€ì§œ ìŠ¤í† ì–´ì…ë‹ˆë‹¤. ì‹¤ì œ ê²°ì œ/íšŒì›/ê°œì¸ì •ë³´ ìˆ˜ì§‘ì€ ì—†ìŠµë‹ˆë‹¤.
  </div>
  <div class="small">
    íŒ) ë¸Œë¼ìš°ì € ê´‘ê³  ì°¨ë‹¨ í™•ì¥í”„ë¡œê·¸ë¨ì´ GA/GTM ìš”ì²­ì„ ë§‰ì„ ìˆ˜ ìˆì–´ìš”. í…ŒìŠ¤íŠ¸ ì¤‘ì—” ì ì‹œ êº¼ë³´ëŠ” ê²Œ ì¢‹ìŠµë‹ˆë‹¤.
  </div>
</footer>

<script src="assets/shop.js"></script>
<script>
  function renderCart() {
    setMemberToggleUI();
    updateCartBadge();

    const cart = getCart();
    const emptyEl = document.getElementById("empty");
    const tableWrap = document.getElementById("tableWrap");
    const body = document.getElementById("cartBody");

    if (!cart.length) {
      emptyEl.style.display = "block";
      tableWrap.style.display = "none";
      return;
    }

    emptyEl.style.display = "none";
    tableWrap.style.display = "block";

    body.innerHTML = "";
    cart.forEach((it, i) => {
      const tr = document.createElement("tr");
      const subtotal = Number(it.price||0) * Number(it.quantity||1);

      tr.innerHTML = `
        <td>
          <div><b>${it.item_name}</b></div>
          <div class="small">SKU: <code class="inline">${it.item_id}</code> Â· variant: <code class="inline">${it.item_variant}</code></div>
        </td>
        <td>${formatKRW(it.price)}ì›</td>
        <td style="width:110px;">
          <input type="number" min="1" value="${it.quantity}" data-qty="${i}" />
        </td>
        <td>${formatKRW(subtotal)}ì›</td>
        <td style="width:120px;">
          <button class="btn danger" data-remove="${i}">ì‚­ì œ</button>
        </td>
      `;
      body.appendChild(tr);
    });

    const value = calcValue(cart);
    document.getElementById("kpiCount").textContent = String(cartCount());
    document.getElementById("kpiValue").textContent = `${formatKRW(value)}ì›`;

    // view_cart
    pushEcomEvent("view_cart", {
      currency: CURRENCY,
      value: value,
      // cartëŠ” ë¦¬ìŠ¤íŠ¸ ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë‹ˆ ìƒëµ
      price_type: "mixed",
      ecommerce: { items: cart }
    });

    // bind qty changes
    body.querySelectorAll("input[data-qty]").forEach(inp => {
      inp.addEventListener("change", () => {
        const idx = Number(inp.getAttribute("data-qty"));
        const qty = Math.max(1, Number(inp.value || 1));
        const cart2 = getCart();
        cart2[idx].quantity = qty;
        saveCart(cart2);
        renderCart();
      });
    });

    // bind removes
    body.querySelectorAll("button[data-remove]").forEach(btn => {
      btn.addEventListener("click", () => {
        const idx = Number(btn.getAttribute("data-remove"));
        const cart2 = getCart();
        cart2.splice(idx, 1);
        saveCart(cart2);
        renderCart();
      });
    });
  }

  document.getElementById("btnClear").onclick = () => {
    clearCart();
    renderCart();
  };

  document.getElementById("btnCheckout").onclick = () => {
    const cart = getCart();
    if (!cart.length) return;

    // begin_checkout
    const value = calcValue(cart);
    pushEcomEvent("begin_checkout", {
      currency: CURRENCY,
      value: value,
      price_type: "mixed",
      ecommerce: { items: cart }
    });

    location.href = "checkout.html";
  };

  bindMemberToggle(() => {
    // íšŒì›ê°€ í† ê¸€ì€ ì¥ë°”êµ¬ë‹ˆì— ë“¤ì–´ê°„ ìƒí’ˆì˜ ê°€ê²©ì„ "ë°”ê¾¸ì§„ ì•ŠìŒ" (ì‹¤ë¬´ì™€ ë¹„ìŠ·í•˜ê²Œ: ë‹´ì„ ë•Œ ê°€ê²© í™•ì •)
    setMemberToggleUI();
    updateCartBadge();
    alert("íšŒì›ê°€ í† ê¸€ì€ 'ìƒˆë¡œ ë‹´ëŠ” ìƒí’ˆ' ê°€ê²©ì—ë§Œ ì˜í–¥ì„ ì¤ë‹ˆë‹¤. (ì¥ë°”êµ¬ë‹ˆ ë‚´ ê°€ê²©ì€ ê·¸ëŒ€ë¡œ)");
  });

  renderCart();
</script>
</body>
</html>
