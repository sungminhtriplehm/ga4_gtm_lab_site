<!doctype html>
<html lang="ko">
<head>
  <title>Lab Shop | Cart</title>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/style.css" />
  <script>
    // dataLayer는 GTM이 로드되기 전에 먼저 선언하는 것이 권장됩니다.
    window.dataLayer = window.dataLayer || [];
  </script>

  <!-- GTM HEAD SNIPPET: Google Tag Manager에서 복사한 <script>...</script>를 여기 붙여넣으세요 -->

</head>
<body>

  <!-- GTM BODY SNIPPET: Google Tag Manager에서 복사한 <noscript>...</noscript>를 여기 붙여넣으세요 -->

<header class="container">
  <a class="brand" href="index.html" aria-label="Home">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>GTM + GA4 전자상거래 실습 미니샵</h1>
      <div class="small">정적 페이지( GitHub Pages ) + dataLayer 기반 이벤트</div>
    </div>
  </a>

  <nav class="nav">
    <div class="pill">
      <label style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" data-member-toggle />
        <span data-member-label>회원가 OFF</span>
      </label>
    </div>

    <a class="pill" href="cart.html">
      🛒 장바구니
      <span class="badge" data-cart-count>0</span>
    </a>
  </nav>
</header>

<main class="container">
  <section class="panel">
    <h2 style="margin:0 0 8px;">장바구니</h2>
    <div class="small">페이지 로드 시 <code class="inline">view_cart</code> 이벤트가 전송됩니다.</div>

    <div id="empty" class="small" style="margin-top:10px; display:none;">
      장바구니가 비어 있습니다. <a class="btn" href="index.html" style="margin-left:8px;">상품 보러가기</a>
    </div>

    <div id="tableWrap" style="margin-top:10px; display:none;">
      <table class="table" aria-label="cart table">
        <thead>
          <tr>
            <th>상품</th>
            <th>단가</th>
            <th>수량</th>
            <th>소계</th>
            <th>작업</th>
          </tr>
        </thead>
        <tbody id="cartBody"></tbody>
      </table>

      <div class="kpi">
        <div class="box">
          <div class="label">상품 수</div>
          <div class="value" id="kpiCount">0</div>
        </div>
        <div class="box">
          <div class="label">총액 (value)</div>
          <div class="value" id="kpiValue">0</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <a class="btn secondary" href="index.html">계속 쇼핑</a>
        <button class="btn" id="btnCheckout">주문하기(Checkout)</button>
        <button class="btn danger" id="btnClear">장바구니 비우기</button>
      </div>
    </div>
  </section>
</main>

<footer class="container">
  <div>
    이 페이지는 GA4/GTM 실습용 가짜 스토어입니다. 실제 결제/회원/개인정보 수집은 없습니다.
  </div>
  <div class="small">
    팁) 브라우저 광고 차단 확장프로그램이 GA/GTM 요청을 막을 수 있어요. 테스트 중엔 잠시 꺼보는 게 좋습니다.
  </div>
</footer>

<script src="assets/shop.js"></script>
<script>
  function renderCart() {
    setMemberToggleUI();
    updateCartBadge();

    const cart = getCart();
    const emptyEl = document.getElementById("empty");
    const tableWrap = document.getElementById("tableWrap");
    const body = document.getElementById("cartBody");

    if (!cart.length) {
      emptyEl.style.display = "block";
      tableWrap.style.display = "none";
      return;
    }

    emptyEl.style.display = "none";
    tableWrap.style.display = "block";

    body.innerHTML = "";
    cart.forEach((it, i) => {
      const tr = document.createElement("tr");
      const subtotal = Number(it.price||0) * Number(it.quantity||1);

      tr.innerHTML = `
        <td>
          <div><b>${it.item_name}</b></div>
          <div class="small">SKU: <code class="inline">${it.item_id}</code> · variant: <code class="inline">${it.item_variant}</code></div>
        </td>
        <td>${formatKRW(it.price)}원</td>
        <td style="width:110px;">
          <input type="number" min="1" value="${it.quantity}" data-qty="${i}" />
        </td>
        <td>${formatKRW(subtotal)}원</td>
        <td style="width:120px;">
          <button class="btn danger" data-remove="${i}">삭제</button>
        </td>
      `;
      body.appendChild(tr);
    });

    const value = calcValue(cart);
    document.getElementById("kpiCount").textContent = String(cartCount());
    document.getElementById("kpiValue").textContent = `${formatKRW(value)}원`;

    // view_cart
    pushEcomEvent("view_cart", {
      currency: CURRENCY,
      value: value,
      // cart는 리스트 컨텍스트가 없으니 생략
      price_type: "mixed",
      ecommerce: { items: cart }
    });

    // bind qty changes
    body.querySelectorAll("input[data-qty]").forEach(inp => {
      inp.addEventListener("change", () => {
        const idx = Number(inp.getAttribute("data-qty"));
        const qty = Math.max(1, Number(inp.value || 1));
        const cart2 = getCart();
        cart2[idx].quantity = qty;
        saveCart(cart2);
        renderCart();
      });
    });

    // bind removes
    body.querySelectorAll("button[data-remove]").forEach(btn => {
      btn.addEventListener("click", () => {
        const idx = Number(btn.getAttribute("data-remove"));
        const cart2 = getCart();
        cart2.splice(idx, 1);
        saveCart(cart2);
        renderCart();
      });
    });
  }

  document.getElementById("btnClear").onclick = () => {
    clearCart();
    renderCart();
  };

  document.getElementById("btnCheckout").onclick = () => {
    const cart = getCart();
    if (!cart.length) return;

    // begin_checkout
    const value = calcValue(cart);
    pushEcomEvent("begin_checkout", {
      currency: CURRENCY,
      value: value,
      price_type: "mixed",
      ecommerce: { items: cart }
    });

    location.href = "checkout.html";
  };

  bindMemberToggle(() => {
    // 회원가 토글은 장바구니에 들어간 상품의 가격을 "바꾸진 않음" (실무와 비슷하게: 담을 때 가격 확정)
    setMemberToggleUI();
    updateCartBadge();
    alert("회원가 토글은 '새로 담는 상품' 가격에만 영향을 줍니다. (장바구니 내 가격은 그대로)");
  });

  renderCart();
</script>
</body>
</html>
