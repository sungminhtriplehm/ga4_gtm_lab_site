<!doctype html>
<html lang="ko">
<head>
  <title>Lab Shop | Thank you</title>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/style.css" />
  <script>
    // dataLayerëŠ” GTMì´ ë¡œë“œë˜ê¸° ì „ì— ë¨¼ì € ì„ ì–¸í•˜ëŠ” ê²ƒì´ ê¶Œì¥ë©ë‹ˆë‹¤.
    window.dataLayer = window.dataLayer || [];
  </script>

  <!-- GTM HEAD SNIPPET: Google Tag Managerì—ì„œ ë³µì‚¬í•œ <script>...</script>ë¥¼ ì—¬ê¸° ë¶™ì—¬ë„£ìœ¼ì„¸ìš” -->

</head>
<body>

  <!-- GTM BODY SNIPPET: Google Tag Managerì—ì„œ ë³µì‚¬í•œ <noscript>...</noscript>ë¥¼ ì—¬ê¸° ë¶™ì—¬ë„£ìœ¼ì„¸ìš” -->

<header class="container">
  <a class="brand" href="index.html" aria-label="Home">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>GTM + GA4 ì „ììƒê±°ë˜ ì‹¤ìŠµ ë¯¸ë‹ˆìƒµ</h1>
      <div class="small">ì •ì  í˜ì´ì§€( GitHub Pages ) + dataLayer ê¸°ë°˜ ì´ë²¤íŠ¸</div>
    </div>
  </a>

  <nav class="nav">
    <div class="pill">
      <label style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" data-member-toggle />
        <span data-member-label>íšŒì›ê°€ OFF</span>
      </label>
    </div>

    <a class="pill" href="cart.html">
      ğŸ›’ ì¥ë°”êµ¬ë‹ˆ
      <span class="badge" data-cart-count>0</span>
    </a>
  </nav>
</header>

<main class="container">
  <section class="panel" id="panel">
    <h2 style="margin:0 0 8px;">êµ¬ë§¤ ì™„ë£Œ ğŸ‰</h2>
    <div class="small">ì´ í˜ì´ì§€ ë¡œë“œ ì‹œ (ìµœì´ˆ 1íšŒ) <code class="inline">purchase</code> ì´ë²¤íŠ¸ê°€ ì „ì†¡ë©ë‹ˆë‹¤.</div>

    <div id="msg" style="margin-top:10px;"></div>

    <div class="row" style="margin-top:12px;">
      <a class="btn" href="index.html">í™ˆìœ¼ë¡œ</a>
      <a class="btn secondary" href="cart.html">ì¥ë°”êµ¬ë‹ˆ ë³´ê¸°</a>
    </div>

    <div class="small" style="margin-top:10px;">
      âš ï¸ ìƒˆë¡œê³ ì¹¨í•˜ë©´ êµ¬ë§¤ ì™„ë£Œ í˜ì´ì§€ê°€ ë‹¤ì‹œ ë¡œë“œë©ë‹ˆë‹¤. ì¤‘ë³µ êµ¬ë§¤ ì´ë²¤íŠ¸ë¥¼ ë§‰ê¸° ìœ„í•´
      <code class="inline">transaction_id</code>ë¥¼ ì‚¬ìš©í•˜ê³ , ë¡œì»¬ì— "ì „ì†¡ ì™„ë£Œ" ì²´í¬ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
    </div>
  </section>
</main>

<footer class="container">
  <div>
    ì´ í˜ì´ì§€ëŠ” GA4/GTM ì‹¤ìŠµìš© ê°€ì§œ ìŠ¤í† ì–´ì…ë‹ˆë‹¤. ì‹¤ì œ ê²°ì œ/íšŒì›/ê°œì¸ì •ë³´ ìˆ˜ì§‘ì€ ì—†ìŠµë‹ˆë‹¤.
  </div>
  <div class="small">
    íŒ) ë¸Œë¼ìš°ì € ê´‘ê³  ì°¨ë‹¨ í™•ì¥í”„ë¡œê·¸ë¨ì´ GA/GTM ìš”ì²­ì„ ë§‰ì„ ìˆ˜ ìˆì–´ìš”. í…ŒìŠ¤íŠ¸ ì¤‘ì—” ì ì‹œ êº¼ë³´ëŠ” ê²Œ ì¢‹ìŠµë‹ˆë‹¤.
  </div>
</footer>

<script src="assets/shop.js"></script>
<script>
  function render() {
    setMemberToggleUI();
    updateCartBadge();

    const orderRaw = sessionStorage.getItem(STORAGE.ORDER);
    const msg = document.getElementById("msg");

    if (!orderRaw) {
      msg.innerHTML = "<div class='small'>ì£¼ë¬¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì²´í¬ì•„ì›ƒ í˜ì´ì§€ì—ì„œ ë‹¤ì‹œ ì§„í–‰í•´ë³´ì„¸ìš”)</div>";
      return;
    }

    let order;
    try { order = JSON.parse(orderRaw); } catch(e) { order = null; }
    if (!order || !order.transaction_id) {
      msg.innerHTML = "<div class='small'>ì£¼ë¬¸ ì •ë³´ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>";
      return;
    }

    msg.innerHTML = `
      <div class="kpi">
        <div class="box"><div class="label">transaction_id</div><div class="value"><code class="inline">${order.transaction_id}</code></div></div>
        <div class="box"><div class="label">value</div><div class="value">${formatKRW(order.value)}ì›</div></div>
        <div class="box"><div class="label">payment_type</div><div class="value">${order.payment_type}</div></div>
      </div>
      <div class="small" style="margin-top:10px;">êµ¬ë§¤ ì´ë²¤íŠ¸ê°€ DebugView/Realtimeì— ë“¤ì–´ì˜¤ëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”.</div>
    `;

    // purchase (í•œ ë²ˆë§Œ)
    if (!hasPurchaseSent(order.transaction_id)) {
      pushEcomEvent("purchase", {
        transaction_id: order.transaction_id,
        currency: order.currency,
        value: order.value,
        tax: order.tax,
        shipping: order.shipping,
        ecommerce: { items: order.items }
      });

      markPurchaseSent(order.transaction_id);

      // ì‹¤ì œ ì‚¬ì´íŠ¸ë¼ë©´ êµ¬ë§¤ ì™„ë£Œ ì´í›„ ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ëŠ” ë¡œì§ì´ ì¼ë°˜ì 
      clearCart();
    }
  }

  render();
</script>
</body>
</html>
