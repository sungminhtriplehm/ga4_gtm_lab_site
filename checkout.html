<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GA4 + GTM Lab | Checkout</title>
  <link rel="stylesheet" href="assets/style.css" />
  <script>
    window.dataLayer = window.dataLayer || [];
  </script>
  <!-- GTM_HEAD_SLOT -->
</head>
<body>
  <!-- GTM_BODY_SLOT -->

  <header class="site-header">
    <div class="container topbar">
      <a class="brand" href="index.html">GA4 + GTM Static Lab Shop</a>
      <div class="top-controls">
        <label class="mode-label" for="trackingMode">Tracking Mode</label>
        <select id="trackingMode" data-tracking-mode>
          <option value="standard">GA4 Standard</option>
          <option value="cafe24">Cafe24 Mode</option>
          <option value="makeshop">MakeShop Mode</option>
          <option value="godomall">GodoMall Mode</option>
        </select>
        <span class="mode-chip">Current: <strong data-current-mode>standard</strong></span>
        <a class="cart-link" href="cart.html">Cart <span class="badge" data-cart-count>0</span></a>
      </div>
    </div>
    <nav class="container page-nav">
      <a href="index.html" data-nav-page="index">Home</a>
      <a href="product.html?sku=SKU_001" data-nav-page="product">Product</a>
      <a href="cart.html" data-nav-page="cart">Cart</a>
      <a href="checkout.html" data-nav-page="checkout">Checkout</a>
      <a href="thankyou.html" data-nav-page="thankyou">Thankyou</a>
      <a href="form.html" data-nav-page="form">Lead Form</a>
      <a href="buttons.html" data-nav-page="buttons">Buttons</a>
      <a href="builder.html" data-nav-page="builder">Builder Mode</a>
    </nav>
  </header>

  <main class="container">
    <section class="panel">
      <h1 class="page-title">체크아웃</h1>
      <p class="small">
        배송정보 제출 시 <code>add_shipping_info</code>, 결제정보 제출 시
        <code>add_payment_info</code>를 전송합니다.
      </p>
      <div id="checkoutContent"></div>
    </section>
  </main>

  <script src="assets/data.js"></script>
  <script src="assets/app.js"></script>
  <script>
    LAB.initCommon("checkout");

    var container = document.getElementById("checkoutContent");
    var cart = LAB.getCart();

    if (!cart.length) {
      container.innerHTML =
        '<p class="small">장바구니가 비어 있습니다.</p>' +
        '<a class="btn secondary" href="index.html">상품 보러가기</a>';
    } else {
      var rows = cart.map(function (item) {
        return (
          "<tr>" +
          "<td>" + item.item_name + "</td>" +
          "<td>" + item.quantity + "</td>" +
          "<td>" + LAB.formatMoney(item.price) + " KRW</td>" +
          "<td>" + LAB.formatMoney(Number(item.price) * Number(item.quantity)) + " KRW</td>" +
          "</tr>"
        );
      }).join("");

      container.innerHTML =
        '<div class="layout-grid two-col">' +
        '  <div class="panel">' +
        "    <h2>주문 상품</h2>" +
        '    <div class="table-wrap">' +
        "      <table>" +
        "        <thead><tr><th>상품</th><th>수량</th><th>단가</th><th>합계</th></tr></thead>" +
        "        <tbody>" + rows + "</tbody>" +
        "      </table>" +
        "    </div>" +
        "    <p><strong>총액: " + LAB.formatMoney(LAB.calcValue(cart)) + " KRW</strong></p>" +
        "  </div>" +
        '  <div class="panel">' +
        "    <h2>배송/결제 정보</h2>" +
        '    <div class="field">' +
        '      <label for="shippingTier">배송 옵션 (shipping_tier)</label>' +
        '      <select id="shippingTier">' +
        '        <option value="Standard">Standard</option>' +
        '        <option value="Express">Express</option>' +
        "      </select>" +
        "    </div>" +
        '    <div class="field" style="margin-top:10px;">' +
        '      <label for="paymentType">결제 수단 (payment_type)</label>' +
        '      <select id="paymentType">' +
        '        <option value="Card">Card</option>' +
        '        <option value="BankTransfer">BankTransfer</option>' +
        '        <option value="MobilePay">MobilePay</option>' +
        "      </select>" +
        "    </div>" +
        '    <div class="btn-row" style="margin-top:12px;">' +
        '      <button class="btn secondary" id="btnShippingInfo" type="button">배송정보 제출</button>' +
        '      <button class="btn secondary" id="btnPaymentInfo" type="button">결제정보 제출</button>' +
        '      <button class="btn accent" id="btnPlaceOrder" type="button">주문 완료로 이동</button>' +
        "    </div>" +
        "  </div>" +
        "</div>";

      document.getElementById("btnShippingInfo").addEventListener("click", function () {
        LAB.pushEcomEvent("add_shipping_info", {
          currency: LAB.currency,
          value: LAB.calcValue(cart),
          shipping_tier: document.getElementById("shippingTier").value,
          ecommerce: { items: cart }
        });
      });

      document.getElementById("btnPaymentInfo").addEventListener("click", function () {
        LAB.pushEcomEvent("add_payment_info", {
          currency: LAB.currency,
          value: LAB.calcValue(cart),
          payment_type: document.getElementById("paymentType").value,
          ecommerce: { items: cart }
        });
      });

      document.getElementById("btnPlaceOrder").addEventListener("click", function () {
        var shippingTier = document.getElementById("shippingTier").value;
        var paymentType = document.getElementById("paymentType").value;
        var order = {
          transaction_id: LAB.generateTransactionId(),
          currency: LAB.currency,
          value: LAB.calcValue(cart),
          shipping_tier: shippingTier,
          payment_type: paymentType,
          items: cart,
          created_at: new Date().toISOString()
        };
        LAB.savePendingOrder(order);
        window.location.href = "thankyou.html";
      });
    }
  </script>
</body>
</html>
