<!doctype html>
<html lang="ko">
<head>
  <title>Lab Shop | Checkout</title>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/style.css" />
  <script>
    // dataLayerëŠ” GTMì´ ë¡œë“œë˜ê¸° ì „ì— ë¨¼ì € ì„ ì–¸í•˜ëŠ” ê²ƒì´ ê¶Œì¥ë©ë‹ˆë‹¤.
    window.dataLayer = window.dataLayer || [];
  </script>

  <!-- GTM HEAD SNIPPET: Google Tag Managerì—ì„œ ë³µì‚¬í•œ <script>...</script>ë¥¼ ì—¬ê¸° ë¶™ì—¬ë„£ìœ¼ì„¸ìš” -->
   
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-TTWSJGDJ');</script>
  <!-- End Google Tag Manager -->

</head>
<body>

  <!-- GTM BODY SNIPPET: Google Tag Managerì—ì„œ ë³µì‚¬í•œ <noscript>...</noscript>ë¥¼ ì—¬ê¸° ë¶™ì—¬ë„£ìœ¼ì„¸ìš” -->

<header class="container">
  <a class="brand" href="index.html" aria-label="Home">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>GTM + GA4 ì „ììƒê±°ë˜ ì‹¤ìŠµ ë¯¸ë‹ˆìƒµ</h1>
      <div class="small">ì •ì  í˜ì´ì§€( GitHub Pages ) + dataLayer ê¸°ë°˜ ì´ë²¤íŠ¸</div>
    </div>
  </a>

  <nav class="nav">
    <div class="pill">
      <label style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" data-member-toggle />
        <span data-member-label>íšŒì›ê°€ OFF</span>
      </label>
    </div>

    <a class="pill" href="cart.html">
      ğŸ›’ ì¥ë°”êµ¬ë‹ˆ
      <span class="badge" data-cart-count>0</span>
    </a>
  </nav>
</header>

<main class="container">
  <section class="panel">
    <h2 style="margin:0 0 8px;">ì²´í¬ì•„ì›ƒ (ëª¨ì˜)</h2>
    <div class="small">ì—¬ê¸°ì„œëŠ” ì‹¤ì œ ê²°ì œê°€ ì•„ë‹Œ, ì´ë²¤íŠ¸ í•™ìŠµìš© íë¦„ë§Œ ë§Œë“­ë‹ˆë‹¤.</div>

    <div id="empty" class="small" style="margin-top:10px; display:none;">
      ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. <a class="btn" href="index.html" style="margin-left:8px;">ìƒí’ˆ ë³´ëŸ¬ê°€ê¸°</a>
    </div>

    <div id="content" style="display:none; margin-top:10px;">
      <div class="grid">
        <div class="panel" style="grid-column: span 7;">
          <h3 style="margin:0 0 10px;">ì£¼ë¬¸ ìƒí’ˆ</h3>
          <div id="summary"></div>
        </div>

        <div class="panel" style="grid-column: span 5;">
          <h3 style="margin:0 0 10px;">ë°°ì†¡/ê²°ì œ ì •ë³´</h3>

          <div class="row">
            <div style="flex:1; min-width:160px;">
              <label>ë°°ì†¡ ì˜µì…˜ (shipping_tier)</label>
              <select id="shippingTier">
                <option value="Standard">Standard</option>
                <option value="Express">Express</option>
              </select>
            </div>
            <div style="flex:1; min-width:160px;">
              <label>ê²°ì œ ìˆ˜ë‹¨ (payment_type)</label>
              <select id="paymentType">
                <option value="Card">Card</option>
                <option value="BankTransfer">BankTransfer</option>
                <option value="MobilePay">MobilePay</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn" id="btnPay">ê²°ì œí•˜ê¸°(ëª¨ì˜)</button>
            <a class="btn secondary" href="cart.html">ì¥ë°”êµ¬ë‹ˆë¡œ</a>
          </div>

          <div class="small" style="margin-top:10px;">
            ë²„íŠ¼ í´ë¦­ ì‹œ <code class="inline">add_shipping_info</code>, <code class="inline">add_payment_info</code>ë¥¼ ì „ì†¡í•œ ë’¤
            êµ¬ë§¤ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer class="container">
  <div>
    ì´ í˜ì´ì§€ëŠ” GA4/GTM ì‹¤ìŠµìš© ê°€ì§œ ìŠ¤í† ì–´ì…ë‹ˆë‹¤. ì‹¤ì œ ê²°ì œ/íšŒì›/ê°œì¸ì •ë³´ ìˆ˜ì§‘ì€ ì—†ìŠµë‹ˆë‹¤.
  </div>
  <div class="small">
    íŒ) ë¸Œë¼ìš°ì € ê´‘ê³  ì°¨ë‹¨ í™•ì¥í”„ë¡œê·¸ë¨ì´ GA/GTM ìš”ì²­ì„ ë§‰ì„ ìˆ˜ ìˆì–´ìš”. í…ŒìŠ¤íŠ¸ ì¤‘ì—” ì ì‹œ êº¼ë³´ëŠ” ê²Œ ì¢‹ìŠµë‹ˆë‹¤.
  </div>
</footer>

<script src="assets/shop.js"></script>
<script>
  function render() {
    setMemberToggleUI();
    updateCartBadge();

    const cart = getCart();
    const emptyEl = document.getElementById("empty");
    const content = document.getElementById("content");
    const summary = document.getElementById("summary");

    if (!cart.length) {
      emptyEl.style.display = "block";
      content.style.display = "none";
      return;
    }

    emptyEl.style.display = "none";
    content.style.display = "block";

    const value = calcValue(cart);
    summary.innerHTML = `
      <table class="table">
        <thead><tr><th>ìƒí’ˆ</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€</th><th>ì†Œê³„</th></tr></thead>
        <tbody>
          ${cart.map(it => `
            <tr>
              <td>${it.item_name}<div class="small">SKU: <code class="inline">${it.item_id}</code></div></td>
              <td>${it.quantity}</td>
              <td>${formatKRW(it.price)}ì›</td>
              <td>${formatKRW(Number(it.price)*Number(it.quantity))}ì›</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
      <div class="kpi">
        <div class="box"><div class="label">ì´ì•¡(value)</div><div class="value">${formatKRW(value)}ì›</div></div>
        <div class="box"><div class="label">í†µí™”(currency)</div><div class="value">${CURRENCY}</div></div>
      </div>
    `;

    document.getElementById("btnPay").onclick = () => {
      const shipping_tier = document.getElementById("shippingTier").value;
      const payment_type = document.getElementById("paymentType").value;

      // add_shipping_info
      pushEcomEvent("add_shipping_info", {
        currency: CURRENCY,
        value: value,
        shipping_tier: shipping_tier,
        ecommerce: { items: cart }
      });

      // add_payment_info
      pushEcomEvent("add_payment_info", {
        currency: CURRENCY,
        value: value,
        payment_type: payment_type,
        ecommerce: { items: cart }
      });

      // ì£¼ë¬¸ ì •ë³´ ìƒì„± (purchaseëŠ” thankyouì—ì„œ 1íšŒë§Œ ë³´ë‚´ë„ë¡)
      const transaction_id = "T_" + Date.now();
      const order = {
        transaction_id,
        currency: CURRENCY,
        value: value,
        tax: 0,
        shipping: 0,
        shipping_tier,
        payment_type,
        items: cart
      };
      sessionStorage.setItem(STORAGE.ORDER, JSON.stringify(order));

      location.href = "thankyou.html?tid=" + encodeURIComponent(transaction_id);
    };
  }

  bindMemberToggle(() => {
    setMemberToggleUI();
    updateCartBadge();
    alert("ì²´í¬ì•„ì›ƒ ë‹¨ê³„ì—ì„œëŠ” íšŒì›ê°€ í† ê¸€ì„ ë°”ê¾¸ì§€ ì•ŠëŠ” ê²Œ ì¼ë°˜ì ì…ë‹ˆë‹¤. (í•™ìŠµìš© UIë¡œë§Œ ì œê³µ)");
  });

  render();
</script>
</body>
</html>
